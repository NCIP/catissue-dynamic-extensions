<?xml version ="1.0"?>

<!--Ant Script for create Build for DynaminExtentions
	This script is to be kept in the base directory of the host project &
	then imported in the deploy.xml of the host application to able to call the DE specific tasks in the host
	application.
-->
<project name="DynamicExtensionsInstallation" basedir="..">

	<property file="DynamicExtensionsInstall.properties" />
	<property name="base.dir" value="." />
	<property name="de.temp.dir" value="${base.dir}/detemp" />
	<property name="temp.dir.DE" value="${base.dir}/temp" />
	<property name="tempcacore.dir" value="${base.dir}/temp_deaudit_related_files" />
	<property name="export.dir" value="${tempcacore.dir}/temp_exported_xmi" />
	<property name="cacoresdk.dir" value="${tempcacore.dir}/caCoreSDK" />
	<property name="cacore.dir" value="${tempcacore.dir}/temp_caCORESDK" />
	<property name="caCORESDK.zip.location" value="${de.temp.dir}/lib/server/caCORESDK.zip" />
	<property name="dezip.dir" value="${tempcacore.dir}/temp_DE_zip" />
	<property name="dejar.dir" value="${tempcacore.dir}/temp_DE_jar" />
	<property name="entity.jar.location" value="${tempcacore.dir}/entity_jar" />

	<property name="oracle.driver.string.DE" value="oracle.jdbc.driver.OracleDriver" />
	<property name="mysql.driver.string.DE" value="com.mysql.jdbc.Driver" />
	<property name="db2.driver.string.DE" value="com.ibm.db2.jcc.DB2Driver" />
	<property name="db2.sql.dir.DE" value="${de.temp.dir}/db/db-install/db2" />
	<property name="db2.dbupgrade.sql.dir.DE" value="${de.temp.dir}/db/db-upgrade/db2" />
	<property name="mysql.sql.dir.DE" value="${de.temp.dir}/db/db-install/MySql" />
	<property name="mysql.dbupgrade.sql.dir.DE" value="${de.temp.dir}/db/db-upgrade/MySql" />
	<property name="oracle.sql.dir.DE" value="${de.temp.dir}/db/db-install/Oracle" />
	<property name="oracle.dbupgrade.sql.dir.DE" value="${de.temp.dir}/db/db-upgrade/Oracle" />
	<property name="dynamicExtensions.jar.dir.DE" value="${de.temp.dir}/binaries/DynamicExtensionsInterface" />
	<property name="lib.dir.DE" value="${de.temp.dir}/lib/server" />
	<property name="extra.lib.dir.DE" value="${de.temp.dir}/lib/extra" />

	<property name="oracle.dialect.string.DE" value="org.hibernate.dialect.Oracle9Dialect" />
	<property name="mysql.dialect.string.DE" value="org.hibernate.dialect.MySQLDialect" />
	<property name="db2.dialect.string.DE" value="org.hibernate.dialect.DB2Dialect" />

	<!-- Target For Upgrading the Database From DE v 1.2.0 to DE v 1.3.0 -->

	<target name="upgrade_db_from_DE_1.2.0_to_DE_1.3.0">
	<delete dir="${de.temp.dir}" failonerror="no" />
	<mkdir dir="${de.temp.dir}" />
		<unzip src="dynamicextensions.zip" dest="${de.temp.dir}">
		</unzip>
			<taskdef resource="net/sf/antcontrib/antcontrib.properties">
				<classpath>
					<pathelement location="${extra.lib.dir.DE}/ant-contrib.jar" />
				</classpath>
			</taskdef>
			<if>
				<equals arg1="mysql" arg2="${database.type}" casesensitive="false" />
				<then>
					<antcall target="upgrade_db_mysql_from_DE_1.2.0_to_DE_1.3.0" />

				</then>
				<elseif>
					<equals arg1="oracle" arg2="${database.type}" casesensitive="false" />
					<then>
						<antcall target="upgrade_db_oracle_from_DE_1.2.0_to_DE_1.3.0" />
					</then>
				</elseif>
				<elseif>
					<equals arg1="db2" arg2="${database.type}" casesensitive="false" />
					<then>
						<antcall target="upgrade_db_db2_from_DE_1.2.0_to_DE_1.3.0" />

					</then>
				</elseif>
				<else>
					<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
				</else>
			</if>
		</target>

	<target name="upgrade_db_from_DE_1.3.0_to_DE_1.4.0">
		<delete dir="${de.temp.dir}" failonerror="no" />
		<mkdir dir="${de.temp.dir}" />
			<unzip src="dynamicextensions.zip" dest="${de.temp.dir}">
			</unzip>
				<taskdef resource="net/sf/antcontrib/antcontrib.properties">
					<classpath>
						<pathelement location="${extra.lib.dir.DE}/ant-contrib.jar" />
					</classpath>
				</taskdef>
				<if>
					<equals arg1="mysql" arg2="${database.type}" casesensitive="false" />
					<then>
						<antcall target="upgrade_db_mysql_from_DE_1.3.0_to_DE_1.4.0" />

					</then>
					<elseif>
						<equals arg1="oracle" arg2="${database.type}" casesensitive="false" />
						<then>
							<antcall target="upgrade_db_oracle_from_DE_1.3.0_to_DE_1.4.0" />
						</then>
					</elseif>
					<elseif>
						<equals arg1="db2" arg2="${database.type}" casesensitive="false" />
						<then>
							<antcall target="upgrade_db_db2_from_DE_1.3.0_to_DE_1.4.0" />

						</then>
					</elseif>
					<else>
						<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
					</else>
				</if>
			</target>

	<target name="upgrade_db_db2_from_DE_1.2.0_to_DE_1.3.0">
		<antcall target="execute_file_db_db2">
			<param name="sql.file.name" value="Upgrade_DE_Metadata_DE_1.2.0_to_DE_1.3.0.sql" />
		</antcall>
	</target>

	<target name="upgrade_db_mysql_from_DE_1.2.0_to_DE_1.3.0">
		<antcall target="execute_file_db_mysql">
			<param name="sql.file.name" value="Upgrade_DE_Metadata_DE_1.2.0_to_DE_1.3.0.sql" />
		</antcall>
	</target>

	<target name="upgrade_db_oracle_from_DE_1.2.0_to_DE_1.3.0">
		<antcall target="execute_file_db_oracle">
			<param name="sql.file.name" value="Upgrade_DE_Metadata_DE_1.2.0_to_DE_1.3.0.sql" />
		</antcall>
	</target>

	<target name="upgrade_db_db2_from_DE_1.3.0_to_DE_1.4.0">
			<antcall target="execute_file_db_db2">
				<param name="sql.file.name" value="Upgrade_DE_Metadata_DE_1.3.0_to_DE_1.4.0.sql" />
			</antcall>
	</target>

		<target name="upgrade_db_mysql_from_DE_1.3.0_to_DE_1.4.0">
			<antcall target="execute_file_db_mysql">
				<param name="sql.file.name" value="Upgrade_DE_Metadata_DE_1.3.0_to_DE_1.4.0.sql" />
			</antcall>
		</target>

		<target name="upgrade_db_oracle_from_DE_1.3.0_to_DE_1.4.0">
			<antcall target="execute_file_db_oracle">
				<param name="sql.file.name" value="Upgrade_DE_Metadata_DE_1.3.0_to_DE_1.4.0.sql" />
			</antcall>
			<sql driver="${oracle.driver.string.DE}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" onerror="continue" delimiter="/" delimitertype="row" keepformat="yes" rdbms="oracle">
				<transaction src="${oracle.dbupgrade.sql.dir.DE}/upgrade_DE_integration_sequences_1.3.0_to_1.4.0.sql" />
				<transaction>commit</transaction>
			<classpath>
					<fileset dir="${lib.dir.DE}">
										<include name="*.jar" />
									</fileset>
								</classpath>
							</sql>
		</target>

	<target name="execute_file_db_mysql">
		<echo message="upgrading the DB For DynamicExtensions" />
		<sql driver="${mysql.driver.string.DE}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}" onerror="continue">
			<transaction src="${mysql.dbupgrade.sql.dir.DE}/${sql.file.name}" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir.DE}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>

	<target name="execute_file_db_oracle">
		<echo message="upgrading the DB For DynamicExtensions" />
		<sql driver="${oracle.driver.string.DE}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" onerror="continue" rdbms="oracle">
			<transaction src="${oracle.dbupgrade.sql.dir.DE}/${sql.file.name}" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir.DE}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>

	<target name="execute_file_db_db2">
		<echo message="upgrading the DB For DynamicExtensions" />
		<sql driver="${db2.driver.string.DE}" url="jdbc:db2//${database.host}:${database.port}/${database.name}:currentSchema=${database.schema};" userid="${database.username}" password="${database.password}" onerror="continue">
			<transaction src="${db2.dbupgrade.sql.dir.DE}/${sql.file.name}" />
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir.DE}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
	</target>



	<property name="filename" value=" " />
	<property name="mainContainerList" value=" " />
	<property name="package" value=" " />
	<property name="addQueryPaths" value=" " />
	<property name="condition" value=" " />
	<property name="categoryDefinitionFilePath" value=" " />
	<property name="hookentity" value=" " />

	<!-- This target will prepare the environment i.e. hibernateconfig files
		other properties file to be able to execute other java classes like import_xmi , create_category etc
-->
	<target name="setupClassExecutionEnvironment">
		<delete dir="${de.temp.dir}" failonerror="no" />
		<mkdir dir="${de.temp.dir}" />
		<mkdir dir="${temp.dir.DE}" />
		<unzip src="dynamicextensions.zip" dest="${de.temp.dir}" overwrite="true">
		</unzip>
		<taskdef resource="net/sf/antcontrib/antcontrib.properties">
			<classpath>
				<pathelement location="${extra.lib.dir.DE}/ant-contrib.jar" />
			</classpath>
		</taskdef>
		<unjar src="./${de.temp.dir}/binaries/DynamicExtensionsInterface/DynamicExtensions.jar" dest="${temp.dir.DE}" overwrite="true" />
		<copy file="./${de.temp.dir}/conf/DynamicExtensionsHibernate.cfg.xml" todir="${temp.dir.DE}" overwrite="true" />
		<copy file="./${de.temp.dir}/conf/ApplicationDAOProperties.xml" todir="${temp.dir.DE}" overwrite="true" />
		<antcall target="create_loggger_properties_file" />
		<if>
			<equals arg1="mysql" arg2="${database.type}" casesensitive="false" />
			<then>
				<replace dir="${temp.dir.DE}">
					<include name="*.cfg.xml" />
					<replacefilter token="@@DIALECT@@" value="${mysql.dialect.string.DE}" />
					<replacefilter token="@@DRIVER@@" value="com.mysql.jdbc.Driver" />
					<replacefilter token="@@URL@@" value="jdbc:mysql://${database.host}/${database.name}" />
				</replace>
				<replace dir="${temp.dir.DE}">
					<include name="ApplicationDAOProperties.xml" />
					<replacefilter token="@@DBPropertyFile@@" value="MySQLDAOProperties.xml" />
				</replace>
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" casesensitive="false" />
				<then>
					<replace dir="${temp.dir.DE}">
						<include name="*.cfg.xml" />
						<replacefilter token="@@DIALECT@@" value="${oracle.dialect.string.DE}" />
						<replacefilter token="@@DRIVER@@" value="${oracle.driver.string.DE}" />
						<replacefilter token="@@URL@@" value="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" />
					</replace>
					<replace dir="${temp.dir.DE}">
						<include name="ApplicationDAOProperties.xml" />
						<replacefilter token="@@DBPropertyFile@@" value="OracleDAOProperties.xml" />
					</replace>
				</then>
			</elseif>
			<elseif>
				<equals arg1="db2" arg2="${database.type}" casesensitive="false" />
				<then>
					<replace dir="${temp.dir.DE}">
						<include name="*.cfg.xml" />
						<replacefilter token="@@DIALECT@@" value="${db2.dialect.string.DE}" />
						<replacefilter token="@@DRIVER@@" value="${db2.driver.string.DE}" />
						<replacefilter token="@@URL@@" value="jdbc:db2//${database.host}:${database.port}/${database.name}:currentSchema=${database.schema};" />
					</replace>
					<replace dir="${temp.dir.DE}">
						<include name="ApplicationDAOProperties.xml" />
						<replacefilter token="@@DBPropertyFile@@" value="Db2DAOProperties.xml" />
					</replace>
				</then>
			</elseif>
		</if>
		<replace dir="${temp.dir.DE}">
			<include name="*.cfg.xml" />
			<replacefilter token="@@DATABASE_USERNAME@@" value="${database.username}" />
			<replacefilter token="@@DATABSE_PASSWORD@@" value="${database.password}" />
		</replace>
	</target>

	<!-- Target used to Import the Dynamic Model using Import XMI -->
	<target name="import_xmi_DE">
		<antcall target="setupClassExecutionEnvironment" />
		<java classname="edu.common.dynamicextensions.xmi.importer.XMIImporter" fork="true" maxmemory="1024M">
			<arg value="${filename}" />
			<arg value="${mainContainerList}" />
			<arg value="${package}" />
			<arg value="${hookentity}" />
			<arg value="${addQueryPaths}" />
			<arg value="${condition}" />

			<classpath>
				<pathelement location="${temp.dir.DE}" />
				<fileset dir="${lib.dir.DE}">
					<include name="*.jar" />
					<exclude name="uml-1.3.jar" />
				</fileset>
				<fileset dir="${extra.lib.dir.DE}">
					<include name="jboss-j2ee.jar" />
					<include name="jta.jar" />
				</fileset>

			</classpath>
		</java>

	</target>

	<!-- Target used to create the Category -->
	<property name="categoryFormNamesFile" value=" " />
	<property name="isPersistMetadataOnly" value=" " />
	<property name="categoryFileDir" value=" " />
	<target name="create_category">
		<antcall target="setupClassExecutionEnvironment" />
		<echo message="Creating Categories" />
		<java classname="edu.common.dynamicextensions.util.CommandLineCategoryCreator" fork="true" maxmemory="1024M">
			<arg value="${categoryFileDir}" />
			<arg value="${Application.url}" />
			<arg value="${categoryFormNamesFile}" />
			<arg value="${isPersistMetadataOnly}" />

			<classpath>
				<pathelement location="${temp.dir.DE}" />
				<fileset dir="${lib.dir.DE}">
					<include name="*.jar" />
					<exclude name="uml-1.3.jar" />
				</fileset>
				<fileset dir="${extra.lib.dir.DE}">
					<include name="jboss-j2ee.jar" />
					<include name="jta.jar" />
				</fileset>
			</classpath>
		</java>

	</target>

	<!--This target executes create_all_categories command for all the  category-forms file specified within csv file-->

	<!--<target name="create_all_categories">
		<antcall target="setupClassExecutionEnvironment" />
		<java classname="edu.common.dynamicextensions.util.MultipleCategoryCreator" fork="true" maxmemory="1024M">
			<arg value="${categoryFormNames}" />
			<classpath>
				<pathelement location="${temp.dir.DE}" />
				<fileset dir="${lib.dir.DE}">
					<include name="*.jar" />
					<exclude name="uml-1.3.jar" />
				</fileset>
				<fileset dir="${extra.lib.dir.DE}">
					<include name="jboss-j2ee.jar" />
					<include name="jta.jar" />
				</fileset>
			</classpath>
		</java>

	</target>-->
	<!--end of  target create_all_categories -->
	<property name="permissibleValuesFile" value=" " />
	<target name="import_permissible_values">
		<antcall target="setupClassExecutionEnvironment" />
		<java classname="edu.common.dynamicextensions.util.parser.ImportPermissibleValues" fork="true" maxmemory="1024M">
			<arg value="${permissibleValuesFile}" />
			<classpath>
				<pathelement location="${temp.dir.DE}" />
				<fileset dir="${lib.dir.DE}">
					<include name="*.jar" />
					<exclude name="uml-1.3.jar" />
				</fileset>
				<fileset dir="${extra.lib.dir.DE}">
					<include name="jboss-j2ee.jar" />
					<include name="jta.jar" />
				</fileset>
			</classpath>
		</java>

	</target>

	<property name="groupname" value="" />
	<property name="version" value="" />

	<target name="export_xmi">
		<java classname="edu.common.dynamicextensions.xmi.exporter.XMIExporter" fork="true" maxmemory="1024M">
			<arg value="${groupname}" />
			<arg value="${relative.filename}" />
			<arg value="${version}" />
			<arg value="${hookentity}" />
			<classpath>
				<pathelement location="${temp.dir.DE}" />
				<fileset dir="${lib.dir.DE}">
					<include name="*.jar" />
					<exclude name="uml-1.3.jar" />
				</fileset>
				<fileset dir="${extra.lib.dir.DE}">
					<include name="jboss-j2ee.jar" />
					<include name="jta.jar" />
				</fileset>
			</classpath>
		</java>
	</target>
	<!-- upgrade category entity names from CP_1.1 to CP_1.2 -->
	<target name="upgrade_category_entity_names">
		<antcall target="setupClassExecutionEnvironment" />
		<java classname="edu.common.dynamicextensions.util.UpgradeCategoryEntityName" fork="true" maxmemory="1024M">
			<classpath>
				<pathelement location="${temp.dir.DE}" />
				<fileset dir="${lib.dir.DE}">
					<include name="*.jar" />
					<exclude name="uml-1.3.jar" />
				</fileset>
				<fileset dir="${extra.lib.dir.DE}">
					<include name="jboss-j2ee.jar" />
					<include name="jta.jar" />
				</fileset>
			</classpath>
		</java>
	</target>
	<!-- upgrade category entity names ends-->


	<target name="create_loggger_properties_file">
		<copy file="./${de.temp.dir}/conf/log4j.properties.template" tofile="./log4j.properties" overwrite="true" />
		<mkdir dir="./log" />
		<replace file="./log4j.properties">
			<replacefilter token="@@jbosshome@@" value="." />
		</replace>
	</target>


	<target name="reset_DE_sequences">
		<delete dir="${de.temp.dir}" failonerror="no" />
		<mkdir dir="${de.temp.dir}" />
		<unzip src="dynamicextensions.zip" dest="${de.temp.dir}">
		</unzip>
		<taskdef resource="net/sf/antcontrib/antcontrib.properties">
			<classpath>
				<pathelement location="${extra.lib.dir.DE}/ant-contrib.jar" />
			</classpath>
		</taskdef>
		<if>
			<equals arg1="mysql" arg2="${database.type}" casesensitive="false" />
			<then>
				<antcall target="reset_DE_sequences_mysql" />
			</then>
			<elseif>
				<equals arg1="oracle" arg2="${database.type}" casesensitive="false" />
				<then>
					<antcall target="reset_DE_sequences_oracle" />
				</then>
			</elseif>
			<elseif>
				<equals arg1="db2" arg2="${database.type}" casesensitive="false" />
				<then>
					<antcall target="reset_DE_sequences_db2" />
				</then>
			</elseif>
			<else>
				<echo message="DATABASE INITIALIZATION FAILED PLEASE CHECK DATABASE.TYPE PROPERTY" level="error" />
			</else>
		</if>
	</target>

	<target name="reset_DE_sequences_oracle">
		<sql driver="${oracle.driver.string.DE}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" onerror="continue" rdbms="oracle">
			<transaction>
								DROP SEQUENCE DE_ATTR_REC_SEQ ;
								DROP SEQUENCE DE_COLL_ATTR_REC_VALUES_SEQ ;
								DROP SEQUENCE DE_FILE_ATTR_REC_VALUES_SEQ ;
								DROP SEQUENCE DE_OBJECT_ATTR_REC_VALUES_SEQ ;
								DROP SEQUENCE DYEXTN_ABSTRACT_METADATA_SEQ ;
								DROP SEQUENCE DYEXTN_ASSO_DISPLAY_ATTR_SEQ ;
								DROP SEQUENCE DYEX_ATTR_TYP_INFO_SEQ ;
								DROP SEQUENCE DYEXTN_CONTAINER_SEQ ;
								DROP SEQUENCE DYEXTN_CONTROL_SEQ ;
								DROP SEQUENCE DYEXTN_DATABASE_PROPERTIES_SEQ ;
								DROP SEQUENCE DYEXTN_DATA_ELEMENT_SEQ ;
								DROP SEQUENCE DYEXTN_ENTITY_MAP_CONDN_SEQ ;
								DROP SEQUENCE DYEXTN_ENTITY_MAP_SEQ ;
								DROP SEQUENCE DYEXTN_ENTITY_RECORD_SEQ ;
								DROP SEQUENCE DYEXTN_FILE_EXTN_SEQ ;
								DROP SEQUENCE DYEXTN_FORM_CONTEXT_SEQ ;
								DROP SEQUENCE DYEXTN_PERMISSIBLEVAL_SEQ ;
								DROP SEQUENCE DYEXTN_ROLE_SEQ ;
								DROP SEQUENCE DYEXTN_RULE_PARAMETER_SEQ ;
								DROP SEQUENCE DYEXTN_RULE_SEQ ;
								DROP SEQUENCE DYEXTN_SEMANTIC_PROPERTY_SEQ ;
								DROP SEQUENCE DYEXTN_TAGGED_VALUE_SEQ ;
								DROP SEQUENCE DYEXTN_VALUE_DOMAIN_SEQ ;
								DROP SEQUENCE DYEXTN_VIEW_SEQ ;
								DROP SEQUENCE DYEXTN_CNSTRKEY_PROP_SEQ;
								</transaction>
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir.DE}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<sql driver="${oracle.driver.string.DE}" url="jdbc:oracle:thin:@${database.host}:${database.port}:${database.name}" userid="${database.username}" password="${database.password}" onerror="continue" delimiter="/" delimitertype="row" keepformat="yes" rdbms="oracle">
			<classpath>
				<fileset dir="${lib.dir.DE}">
					<include name="*.jar" />
				</fileset>
			</classpath>
			<transaction src="${oracle.sql.dir.DE}/createDESequence.SQL" />
		</sql>
	</target>

	<target name="reset_DE_sequences_mysql">
		<!--<sql driver="${mysql.driver.string.DE}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}" onerror="continue" rdbms="oracle">
			<transaction>
									DROP SEQUENCE DE_ATTR_REC_SEQ ;
									DROP SEQUENCE DE_COLL_ATTR_REC_VALUES_SEQ ;
									DROP SEQUENCE DE_FILE_ATTR_REC_VALUES_SEQ ;
									DROP SEQUENCE DE_OBJECT_ATTR_REC_VALUES_SEQ ;
									DROP SEQUENCE DYEXTN_ABSTRACT_METADATA_SEQ ;
									DROP SEQUENCE DYEXTN_ASSO_DISPLAY_ATTR_SEQ ;
									DROP SEQUENCE DYEX_ATTR_TYP_INFO_SEQ ;
									DROP SEQUENCE DYEXTN_CONTAINER_SEQ ;
									DROP SEQUENCE DYEXTN_CONTROL_SEQ ;
									DROP SEQUENCE DYEXTN_DATABASE_PROPERTIES_SEQ ;
									DROP SEQUENCE DYEXTN_DATA_ELEMENT_SEQ ;
									DROP SEQUENCE DYEXTN_ENTITY_MAP_CONDN_SEQ ;
									DROP SEQUENCE DYEXTN_ENTITY_MAP_SEQ ;
									DROP SEQUENCE DYEXTN_ENTITY_RECORD_SEQ ;
									DROP SEQUENCE DYEXTN_FILE_EXTN_SEQ ;
									DROP SEQUENCE DYEXTN_FORM_CONTEXT_SEQ ;
									DROP SEQUENCE DYEXTN_PERMISSIBLEVAL_SEQ ;
									DROP SEQUENCE DYEXTN_ROLE_SEQ ;
									DROP SEQUENCE DYEXTN_RULE_PARAMETER_SEQ ;
									DROP SEQUENCE DYEXTN_RULE_SEQ ;
									DROP SEQUENCE DYEXTN_SEMANTIC_PROPERTY_SEQ ;
									DROP SEQUENCE DYEXTN_TAGGED_VALUE_SEQ ;
									DROP SEQUENCE DYEXTN_VALUE_DOMAIN_SEQ ;
									DROP SEQUENCE DYEXTN_VIEW_SEQ ;
									DROP SEQUENCE DYEXTN_CNSTRKEY_PROP_SEQ;
									</transaction>
			<transaction>commit;</transaction>
			<classpath>
				<fileset dir="${lib.dir.DE}">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</sql>
		<sql driver="${mysql.driver.string.DE}" url="jdbc:mysql://${database.host}:${database.port}/${database.name}" userid="${database.username}" password="${database.password}" onerror="continue" delimiter="/" delimitertype="row" keepformat="yes" rdbms="oracle">
			<classpath>
				<fileset dir="${lib.dir.DE}">
					<include name="*.jar" />
				</fileset>
			</classpath>
			<transaction src="${mysql.sql.dir.DE}/createDESequence.SQL" />
		</sql>-->
	</target>
	<target name="reset_DE_sequences_db2">
		<sql driver="${db2.driver.string.DE}" url="jdbc:db2//${database.host}:${database.port}/${database.name}:currentSchema=${database.schema};" userid="${database.username}" password="${database.password}" onerror="continue" delimiter="#">
			<classpath>
				<fileset dir="${lib.dir.DE}">
					<include name="*.jar" />
				</fileset>
			</classpath>
			<transaction src="${db2.sql.dir.DE}/createDESequence.SQL" />
		</sql>
	</target>


	<!-- =================================
          target: import.xmi.to.generate.cacore
         ================================= -->
    <target name="import.xmi.to.generate.cacore" depends="" description="description">
    	<property name="xmi.name" value="${}" />
    	<property name="mainContainerList" value="${}" />
    	<property name="package.name" value="${}" />
    	<property name="hookentity" value="${}" />
    	<property name="addQueryPaths" value="${}" />
    	<property name="testcases" value="${}" />

    	<antcall target="import_xmi_DE">
			<param name="filename" value="${xmi.name}"/>
			<param name="mainContainerList" value="${mainContainerList}" />
			<param name="package" value="${package.name}" />
			<param name="hookentity" value="${hookentity}" />
			<param name="addQueryPaths" value="${addQueryPaths}" />
		</antcall>


    	<delete dir="${tempcacore.dir}" />
    	<mkdir dir="${tempcacore.dir}" />

    	<delete dir="${export.dir}" />
    	<mkdir dir="${export.dir}" />

		<antcall target="export.xmi.and.generate.cacore.for.imported.xmis">
			<param name="entityGroup" value="${xmi.name}"/>
			<param name="testcases" value="${testcases}"/>
		</antcall>
    </target>

	<!-- =================================
          target: generate.cacore.for.imported.xmis
         ================================= -->
    <target name="generate.cacore.for.imported.xmis" depends="setupClassExecutionEnvironment" description="description">

    	<property name="testcases" value="False" />

		<java failonerror="true" classname="edu.wustl.metadata.util.EntityGroupName" fork="yes" >
			<arg value="${basedir}/temp_deaudit_related_files/temp_exported_xmi/"/>
			<classpath>
				<pathelement location="${temp.dir.DE}" />
				<fileset dir="${lib.dir.DE}">
					<include name="*.jar" />
					<exclude name="uml-1.3.jar" />
				</fileset>
				<fileset dir="${extra.lib.dir.DE}">
					<include name="jboss-j2ee.jar" />
					<include name="jta.jar" />
				</fileset>
			</classpath>
		</java>

		<property file="${tempcacore.dir}/temp_exported_xmi/EntityGroup.properties" />
		<foreach list="${entity.group.name}" param="xmi.name"  target="export.xmi.and.generate.cacore" />

    </target>

	<!-- =================================
          target:export.xmi.and.generate.cacore
         ================================= -->
    <target name="export.xmi.and.generate.cacore" depends="" description="description">

    	<mkdir dir="${dezip.dir}" />
		<mkdir dir="${dejar.dir}" />


		<java failonerror="true" classname="edu.wustl.metadata.util.PackageName" fork="yes" >
			<arg value="${export.dir}/"/>
			<arg value="${xmi.name}"/>

			<classpath>
				<pathelement location="${temp.dir.DE}" />
				<fileset dir="${lib.dir.DE}">
					<include name="*.jar" />
					<exclude name="uml-1.3.jar" />
				</fileset>
				<fileset dir="${extra.lib.dir.DE}">
					<include name="jboss-j2ee.jar" />
					<include name="jta.jar" />
				</fileset>

			</classpath>

		</java>
		<property file="${export.dir}/Package.properties" />

		<property name="entitygroupname" value="${entity.name}" />
		<property name="xmi.filename" value="${export.dir}/${entity.name}.xmi" />
		<property name="version.number" value="1.1" />

    	<antcall target="export_xmi">
    		<param name="setup.method.required" value="False" />
			<param name="groupname" value="${entitygroupname}"/>
    		<param name="relative.filename" value="${xmi.filename}"/>
			<param name="version" value="${version.number}"/>
    		<param name="hookentity" value="edu.wustl.clinportal.domain.ParticipantRecordEntry" />
    	</antcall>

    	<antcall target="generate.cacore" />
    </target>

	<!-- - - - - - - - - - - - - - - - - -
          target: generate.cacore
         - - - - - - - - - - - - - - - - - -->
    <target name="generate.cacore">
    	<echo message=" "/>
		<echo message="-------------------------"/>
		<echo message=" Now creating caCORE war "/>
		<echo message="-------------------------"/>
		<echo message=" "/>

		<antcall target="unzip_caCORESDKzip">
			<param name="entity.group.name" value="${entitygroupname}"/>
			<param name="entity.package.name" value="${cacore.package.name}"/>
		</antcall>

    	<ant antfile="build.xml" dir="${cacoresdk.dir}" target="build-system" />

    	<delete dir="${cacore.dir}" />
    	<mkdir dir="${cacore.dir}" />
    	<unwar dest="${cacore.dir}" src="${cacoresdk.dir}/output/${entitygroupname}/package/${entitygroupname}.war" overwrite="true"/>

    	<if>
    		<equals arg1="True" arg2="${testcases}" />
    		<then>
    			<copy todir="./classes/${de.package.name}/" overwrite="true">
    				<fileset dir="${cacore.dir}/WEB-INF/classes/${de.package.name}">
    					<include name="**/*" />
    				</fileset>
    			</copy>
    		</then>
    		<else>
    			<unzip src="${de.zip.location}/dynamicextensions.zip" dest="${dezip.dir}" overwrite="true" />

    	    	<copy todir="${entity.jar.location}/${de.package.name}" overwrite="true">
    	    		<fileset dir="${cacore.dir}/WEB-INF/classes/${de.package.name}">
    	    			<include name="**/*" />
    	    		</fileset>
    	    	</copy>

    	    	<property name="caCOREHibernateCfgFile" value="${cacore.dir}/WEB-INF/classes/orm1.cfg.xml"/>
    	    	<property name="DEHibernateWebCfgFile" value="${dezip.dir}/conf/DynamicExtensionsHibernateWeb.cfg.xml" />

    	    	<java classname="edu.wustl.metadata.util.CacoreDEMetadataAppender" fork="true" maxmemory="1024M">
    	    		<arg value="${DEHibernateWebCfgFile}" />
    	    		<arg value="${caCOREHibernateCfgFile}" />
    				<classpath>
    					<pathelement location="${temp.dir.DE}" />
    					<fileset dir="${lib.dir.DE}">
    						<include name="*.jar" />
    						<exclude name="uml-1.3.jar" />
    					</fileset>
    					<fileset dir="${extra.lib.dir.DE}">
    						<include name="jboss-j2ee.jar" />
    						<include name="jta.jar" />
    					</fileset>
    				</classpath>
    			</java>
    		</else>
    	</if>

		<delete>
			<fileset dir="${export.dir}/">
				<include name="**/*.txt"/>
				<include name="**/Package.properties" />
			</fileset>
		</delete>

    	<antcall target="build_artifacts" />
    </target>

	<target name="unzip_caCORESDKzip">
		<delete dir="${cacoresdk.dir}"/>
		<mkdir dir="${cacoresdk.dir}"/>

		<unzip src="${caCORESDK.zip.location}" dest="${cacoresdk.dir}" overwrite="true" />
		<copy todir="${cacoresdk.dir}/models/xmi" overwrite="true">
			<fileset dir="${export.dir}">
				<include name="*.xmi" />
			</fileset>
		</copy>

		<replace dir="${cacoresdk.dir}/conf">
			<include name="deploy.properties" />
			<replacefilter token="@@ENTITYNAME@@" value="${entity.group.name}.xmi" />
			<replacefilter token="@@FIXED_ENTITYNAME@@" value="fixed_${entity.group.name}.xmi" />
			<replacefilter token="@@PACKAGE_NAME@@" value="${entity.package.name}" />
			<replacefilter token="@@APPLICATION_NAME@@" value="${entity.group.name}" />
		</replace>

	</target>

	<target name="build_artifacts">
		<echo message=" "/>
		<echo message="-----------------------------------------"/>
		<echo message=" Now creating ${entitygroupname}.jar file "/>
		<echo message="-----------------------------------------"/>
		<echo message=" "/>

		<!-- Create ${entitygroupname}.jar file. -->
		<jar destfile="${entity.jar.location}/${entitygroupname}.jar" basedir="${entity.jar.location}"/>

		<copy todir="${entityGroup.jar.location}/" file="${entity.jar.location}/${entitygroupname}.jar" overwrite="true" />

		<echo message=" "/>
		<echo message="-----------------------------------------"/>
		<echo message=" Now creating dynamicExtensions.zip file "/>
		<echo message="-----------------------------------------"/>
		<echo message=" "/>

		<!-- Create dynamicextensions.zip file. -->
		<zip destfile="${dezip.dir}/dynamicextensions.zip" basedir="${dezip.dir}" />

		<copy todir="${base.dir}/" file="${dezip.dir}/dynamicextensions.zip" overwrite="true"/>

		<delete>
			<fileset dir="${cacore.dir}">
				<include name="**/*"/>
			</fileset>
		</delete>

		<delete>
			<fileset dir="${dezip.dir}">
				<include name="**/*"/>
			</fileset>
		</delete>
	</target>

</project>
